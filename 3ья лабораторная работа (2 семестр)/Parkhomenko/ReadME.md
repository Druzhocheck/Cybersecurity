# Лабораторная работа 3.1
## Задание:
Настроить VPN соединения с использованием Wireguard и IPSec/IKEv2.
Начнем с создания VPN с помощью Wireguard.
## Настройка VPN-соединения wireguard
### 1. Создание сервера:
В качестве провайдера выделенного сервера была выбрана компания Selectel.
После регистрации и выбора конфигурации сервера ждем установки ОС Ubuntu 20.04, подклдючаемся к нему по протоколу ssh и начинаем настройку VPN с его стороны:
### 2. Обновим ОС:
```sh
apt update && apt upgrade
```
(Все действия производятся от имени root)
### 3. Установим Wireguard:
```sh
apt install wireguard
```
### 4. Настраиваем перенаправление пакетов:
```sh
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
```
### 5. Создаем приватный и публичный ключи для сервера:
```sh
wg genkey | tee /etc/wireguard/privatekey | wg pubkey | tee /etc/wireguard/publickey
```
### 6. Создаем конфигурационный файл Wireguard со следующим содержанием:
```sh
[Interface]
Address = 10.0.0.1/24            # Присвоенный IP нашего сервера внутри сети
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
ListenPort = 51830               # Порт, к которому будут подключаться клиенты
PrivateKey = <здесь вставляем ПРИВАТНЫЙ ключ сервера>
```
### 7. Ввод интерфейса и запуск сервиса:
```sh
wg-quick up wg0						      # Ввод интерфейса wg0
systemctl enable wg-quick@wg0		# Настройка сервиса на запуск при загрузке системы
systemctl start wg-quick@wg0		# Запуск сервиса Wireguard
systemctl status wg-quick@wg0		# Проверяем статуса сервиса
wg show wg0							        # Проверяем состояние интерфейса wg0
```

### 8. Даллее необходимо настроить клиента:
В качестве клиента выбрана виртуальная машина с ОС Windows 10.
Скачиваем Wireguard с официального сайта: https://www.wireguard.com/install/ .

Далее нажимаем кнопку создать пустой туннель, таким образом создается конфигурационный файл, содержащий публичный и приватный ключи клиента.
Конечный файл конфигурации клиента будет выглядеть следующим образом:
```sh
[Interface]
PrivateKey = <приватный ключ клиента>
Address = 10.0.0.2/32          # назначаем адрес внутри сети VPN 
DNS = 8.8.8.8                  # указываем DNS

[Peer]
PublicKey = <Публичный ключ сервера>
AllowedIPs = 0.0.0.0/0         # указываем разрешенный диапазон адресов (0.0.0.0/0 = весь трафик)
Endpoint = 188.68.222.214:51830 # IP нашего сервера и порт, к которому будет совершено подключение
```
Публичный ключ клиента и ip-адрес необходимо добавить в файл конфигурации сервера wg0.conf следующим образом:
```sh
[Peer]
PublicKey = <публичный ключ клиента> # созданный на стороне клиента ключ
AllowedIPs = 10.0.0.2/32             # присвоенный клиенту IP
```
После изменения конфигурационного файла wg0.conf перезаупскаем сервис Wireguard:
```sh
systemctl restart wg-quick@wg0
```
В окне программы Wireguard на стороне клиента нужно нажать кнопку **Подключить**, для того чтобы соединение VPN было установлено

## Настройка VPN соединения с использованием IPSec/IKEv2.
### 1. Обновим ОС:
```sh
apt update
apt upgrade
```
### 2. Установка VPN сервера с IPSec/IKEv2:

Установка выполняется  с использованием автоматического скрипта, для установки необходимо выполнить команду:
```sh
wget https://git.io/vpnsetup -qO vpn.sh && sudo sh vpn.sh
```
Результатом работы скрипта является настройка VPN сервера с IPSec/IKEv2, генерация учетных данных для подключения, а так же файлов конфигурации клиента для различных ОС.

### 3. Настройка IPSec/IKEv2 на стороне клиента:
В качестве клиента в этот раз будет использована хост-система с ОС Windows 10
Настройка подключения на клиенте выполняется в соответствии с инструкцией https://github.com/hwdsl2/setup-ipsec-vpn/blob/master/docs/ikev2-howto.md#windows-7-8-10-and-11

1. Переносим файл с расширением `.p12` на систему.
2. Скачиваем сценарий ikev2_config_import.cmd с репозитория в ту же папку, что и предыдущий файл
3. Разблокируем сценарий в свойствах файла
4. Запускаем его от имени администратора

В окне командной строки вводим наши учетныеданные, которые были получены после активации скрипта на сервере.

### 4. Подключение к VPN серверу с IPSec/IKEv2:
Для подключения к VPN:

1. Выбрать значок "Доступ в интернет" в системном трее.
2. Выбрать пункт VPN и нажать «Подключиться». 
3. При появлении запроса ввести имя пользователя и пароль VPN, полученные при конфигурировании сервера, затем нажать «ОК».

## Запись трафика
Скачиваем программу wireshark, устанавливаем ее на хост систему.
Открываем ее и записываем весь трафик, идущий через адаптер WiFi

Результаты занесены в два файла:
- IPSec windows(host)
- wireshark windows(VM)

## Вывод:
В результате выполнения лабораторной работы произведена настройка VPN соединения с использованием wireshark и IPSec/IKEv2. Для проверки рабостоспособности был записан и проанализирован трафик.

Ссылка на архив с файлами .pcap: https://mega.nz/folder/t89SkSjZ#eiKdBD8KQ8fQ11YWuTiUvw




























